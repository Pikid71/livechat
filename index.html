<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLACK HOLE CHAT V2 üï≥Ô∏è</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23667eea' opacity='0.3'/><path d='M30 50 Q50 65 70 50' stroke='%23667eea' stroke-width='3' fill='none' stroke-linecap='round' opacity='0.5'/><text x='50' y='80' font-size='12' text-anchor='middle' fill='white'>V2</text></svg>">
    <style>
        /* ========== GLOBAL STYLES ========== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', 'Courier New', monospace, sans-serif;
        }
        
        body { 
            background: radial-gradient(circle at 20% 30%, #0a0a0a 0%, #1a0a2e 100%);
            color: white; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow-x: hidden;
        }

        /* ========== THEME VARIABLES ========== */
        body[data-theme="default"] {
            background: radial-gradient(circle at 20% 30%, #0a0a0a 0%, #1a0a2e 100%);
        }
        body[data-theme="dark"] {
            background: #0a0a0a;
        }
        body[data-theme="light"] {
            background: #f0f0f0;
            color: #222;
        }
        body[data-theme="light"] .msg {
            color: #222;
            background: #e0e0e0;
        }
        body[data-theme="neon"] {
            background: #000;
            color: #0ff;
        }
        body[data-theme="neon"] .msg {
            border: 1px solid #0ff;
            box-shadow: 0 0 10px #0ff;
        }
        body[data-theme="midnight"] {
            background: linear-gradient(135deg, #0b0b2b 0%, #1a1a3a 100%);
        }
        body[data-theme="sunset"] {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
        }
        body[data-theme="sunset"] .msg {
            background: rgba(255, 126, 95, 0.3);
        }
        body[data-theme="forest"] {
            background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);
        }
        body[data-theme="ocean"] {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
        }
        body[data-theme="cyberpunk"] {
            background: linear-gradient(135deg, #ff0099 0%, #493240 100%);
        }
        body[data-theme="vintage"] {
            background: #f4e4c1;
            color: #5d3a1a;
        }
        body[data-theme="vintage"] .msg {
            background: #d4c4a1;
            color: #3d2a0a;
        }

        /* ========== EFFECT STYLES ========== */
        body.glitch {
            animation: glitch 0.3s infinite;
        }
        @keyframes glitch {
            0% { transform: translate(0); filter: hue-rotate(0deg); }
            20% { transform: translate(-5px, 3px); filter: hue-rotate(90deg); }
            40% { transform: translate(5px, -3px); filter: hue-rotate(180deg); }
            60% { transform: translate(-3px, 5px); filter: hue-rotate(270deg); }
            80% { transform: translate(3px, -5px); filter: hue-rotate(360deg); }
            100% { transform: translate(0); filter: hue-rotate(0deg); }
        }

        body.flashbang {
            background: white !important;
            transition: background 0.1s;
        }
        body.flashbang #chat-container {
            background: white !important;
            color: black !important;
        }

        body.black {
            background: black !important;
        }
        body.black #chat-container {
            opacity: 0.8;
        }

        body.hack {
            background: black !important;
            color: #00ff00 !important;
            font-family: 'Courier New', monospace !important;
        }
        body.hack .msg {
            font-family: 'Courier New', monospace !important;
            color: #00ff00 !important;
            background: #001100 !important;
            border: 1px solid #00ff00 !important;
            text-shadow: 0 0 5px #00ff00;
        }
        body.hack .header {
            background: #001100 !important;
            border-bottom: 2px solid #00ff00 !important;
        }
        body.hack .header h1 {
            color: #00ff00 !important;
        }

        body.matrix {
            background: black !important;
            position: relative;
        }
        body.matrix::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0,255,0,0.1) 0px, rgba(0,255,0,0.1) 2px, transparent 2px, transparent 4px);
            pointer-events: none;
            animation: matrix 20s linear infinite;
        }
        @keyframes matrix {
            from { background-position: 0 0; }
            to { background-position: 0 100%; }
        }

        body.rainbow {
            animation: rainbow-bg 3s linear infinite;
        }
        @keyframes rainbow-bg {
            0% { background: #ff0000; }
            17% { background: #ff8800; }
            33% { background: #ffff00; }
            50% { background: #00ff00; }
            67% { background: #0088ff; }
            83% { background: #8800ff; }
            100% { background: #ff0000; }
        }

        body.neon {
            animation: neon-pulse 1s ease-in-out infinite alternate;
        }
        @keyframes neon-pulse {
            from { box-shadow: 0 0 10px #0ff, 0 0 20px #0ff, 0 0 30px #0ff; }
            to { box-shadow: 0 0 20px #f0f, 0 0 40px #f0f, 0 0 60px #f0f; }
        }

        body.firework::after {
            content: "üéÜ üéá ‚ú®";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            animation: firework 2s ease-out;
            pointer-events: none;
        }
        @keyframes firework {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(2); }
        }

        body.gameroom {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        body.gameroom #chat-container {
            border: 4px solid #ffd700;
            box-shadow: 0 0 30px #ffd700;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s ease-out forwards;
            pointer-events: none;
            z-index: 9999;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* ========== NOTIFICATION BUTTON ========== */
        .notification-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid gold;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .notification-btn:hover {
            background: gold;
            color: black;
            transform: translateY(-2px);
        }
        
        .notification-btn.enabled {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
        }
        
        .notification-btn.enabled:hover {
            background: #2ecc71;
            color: white;
        }

        /* ========== RANK BADGES ========== */
        .rank-owner {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 6px;
            border: 1px solid #fff;
            box-shadow: 0 0 10px #FFD700;
            display: inline-block;
        }
        .rank-admin {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 6px;
            display: inline-block;
        }
        .rank-moderator {
            background: linear-gradient(135deg, #ff9933 0%, #ff6600 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 6px;
            display: inline-block;
        }
        .rank-vip {
            background: linear-gradient(135deg, #9933ff 0%, #6600cc 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 6px;
            display: inline-block;
        }
        .rank-member {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 6px;
            display: inline-block;
        }

        /* ========== PRIVATE MESSAGE STYLES ========== */
        .msg.private {
            border-left: 4px solid #ff00ff;
            position: relative;
            background: rgba(128, 0, 128, 0.2);
        }
        .msg.private::before {
            content: 'üîí';
            position: absolute;
            top: -8px;
            left: -8px;
            font-size: 12px;
            background: #333;
            border-radius: 50%;
            padding: 2px;
            z-index: 10;
        }
        .private-badge {
            display: inline-block;
            background: rgba(255, 0, 255, 0.3);
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 9px;
            margin-left: 5px;
            color: #ff99ff;
        }
        .admin-view-badge {
            background: rgba(255, 215, 0, 0.3);
            color: gold;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 9px;
            margin-left: 5px;
        }

        /* ========== HELP MENU STYLES - FIXED ========== */
        .help-menu {
            background: rgba(20, 20, 40, 0.95);
            border: 2px solid #667eea;
            border-radius: 16px;
            padding: 20px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .help-section {
            margin: 15px 0;
            padding: 10px;
            border-left: 3px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .help-title {
            color: #ffd700;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .help-command {
            color: #4ade80;
            font-weight: bold;
        }
        
        .help-desc {
            color: #ccc;
            margin-left: 20px;
            font-size: 13px;
        }
        
        .help-rank {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-right: 5px;
        }
        
        .help-rank.owner { background: gold; color: black; }
        .help-rank.admin { background: #ff4444; color: white; }
        .help-rank.mod { background: #ff9933; color: white; }
        .help-rank.vip { background: #9933ff; color: white; }
        .help-rank.member { background: #667eea; color: white; }

        /* ========== CHAT CONTAINER ========== */
        #chat-container { 
            width: 100%;
            max-width: 800px;
            height: 95vh;
            background: rgba(15, 15, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px; 
            overflow: hidden; 
            border: 2px solid rgba(102, 126, 234, 0.5);
            box-shadow: 0 20px 80px rgba(0,0,0,0.8), inset 0 0 30px rgba(102, 126, 234, 0.1);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            transition: all 0.3s ease;
            position: relative;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== HEADER ========== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(102, 126, 234, 0.5);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
        }

        .header h1 { 
            font-size: 22px; 
            font-weight: 700; 
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-info { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 14px; 
            background: rgba(0,0,0,0.2);
            padding: 8px 16px;
            border-radius: 30px;
            backdrop-filter: blur(5px);
        }

        .status-dot { 
            width: 10px; 
            height: 10px; 
            background: #4ade80; 
            border-radius: 50%; 
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px #4ade80;
        }

        @keyframes pulse { 
            0%, 100% { opacity: 1; box-shadow: 0 0 10px #4ade80; } 
            50% { opacity: 0.5; box-shadow: 0 0 5px #4ade80; } 
        }

        /* ========== MESSAGES AREA ========== */
        #messages { 
            flex: 1;
            overflow-y: auto; 
            padding: 24px; 
            display: flex; 
            flex-direction: column; 
            gap: 16px;
            background: rgba(10, 10, 24, 0.8);
            scroll-behavior: smooth;
        }

        .msg-wrapper { 
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-wrapper.mine {
            align-items: flex-end;
        }

        .msg-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 12px;
            flex-wrap: wrap;
        }

        .msg-username {
            font-weight: 700;
            color: #a0a0ff;
            letter-spacing: 0.5px;
        }

        .msg-timestamp {
            color: #888;
            font-size: 10px;
        }

        .msg { 
            background: rgba(74, 74, 94, 0.8);
            backdrop-filter: blur(5px);
            padding: 12px 18px; 
            border-radius: 18px; 
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
            color: #fff;
            line-height: 1.5;
            position: relative;
        }

        .msg:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .msg.mine { 
            background: linear-gradient(135deg, #4169e1 0%, #6a5acd 100%);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .msg.system {
            background: rgba(42, 42, 62, 0.9);
            border: 1px solid #667eea;
            color: #b0b0e0;
            font-style: italic;
            align-self: center;
            max-width: 90%;
            text-align: center;
        }

        .msg.file-share {
            background: rgba(0, 128, 128, 0.3);
            border-left: 4px solid #00ffff;
            cursor: pointer;
        }

        .msg.file-share:hover {
            background: rgba(0, 128, 128, 0.5);
        }

        .file-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .file-info:hover {
            background: rgba(0, 255, 255, 0.1);
        }

        .file-name {
            font-weight: bold;
            color: #00ffff;
            word-break: break-all;
        }

        .file-size {
            font-size: 11px;
            color: #aaa;
        }

        /* ========== INPUT AREA ========== */
        #input-area { 
            padding: 20px; 
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(10px);
            border-top: 2px solid #667eea;
            flex-shrink: 0;
        }

        .input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        #messageInput { 
            flex: 1;
            min-width: 200px;
            background: rgba(51, 51, 51, 0.8); 
            border: 2px solid #444;
            padding: 14px 18px; 
            color: white; 
            border-radius: 30px; 
            outline: none;
            font-size: 15px;
            transition: all 0.3s;
        }

        #messageInput:focus { 
            border-color: #667eea; 
            box-shadow: 0 0 0 4px rgba(102,126,234,0.2);
            background: rgba(51, 51, 51, 0.95);
        }

        .action-btn {
            background: rgba(102, 126, 234, 0.2);
            border: 2px solid #667eea;
            padding: 12px 18px;
            color: white;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .action-btn.danger {
            background: rgba(192, 57, 43, 0.2);
            border-color: #c0392b;
        }

        .action-btn.danger:hover {
            background: #c0392b;
        }

        .action-btn.success {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
        }

        .action-btn.success:hover {
            background: #2ecc71;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ========== EMOJI PANEL ========== */
        .emoji-panel {
            background: rgba(26, 26, 62, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px;
            border-radius: 16px;
            border: 1px solid #667eea;
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .emoji-panel.show { 
            display: grid; 
        }

        .emoji-item {
            font-size: 28px;
            cursor: pointer;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.2s;
            text-align: center;
            background: rgba(255,255,255,0.05);
        }

        .emoji-item:hover { 
            background: rgba(102, 126, 234, 0.4); 
            transform: scale(1.3) rotate(10deg);
        }

        /* ========== MODALS ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #667eea;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
        }

        .modal-body {
            color: #fff;
        }

        .user-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #333;
            transition: all 0.2s;
        }

        .user-list-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .user-info-modal {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-rank-badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        /* ========== ROOMS LIST ========== */
        #room-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: rgba(15, 15, 15, 0.95);
        }

        .room-card {
            background: rgba(34, 34, 34, 0.8);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #444;
            margin-bottom: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }

        .room-card:hover {
            border-color: #667eea;
            transform: translateX(5px);
            background: rgba(34, 34, 34, 0.95);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .room-name {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .room-stats {
            display: flex;
            gap: 16px;
            color: #888;
            font-size: 13px;
        }

        .room-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ========== VOICE CHAT ========== */
        .voice-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(46, 204, 113, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            margin-left: 12px;
            border: 1px solid #2ecc71;
        }

        .voice-wave {
            display: flex;
            gap: 3px;
        }

        .voice-wave span {
            width: 4px;
            height: 4px;
            background: #2ecc71;
            border-radius: 2px;
            animation: wave 1s infinite;
        }

        .voice-wave span:nth-child(2) { animation-delay: 0.2s; }
        .voice-wave span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { height: 4px; }
            50% { height: 12px; }
        }

        /* ========== SCROLLBARS ========== */
        #messages::-webkit-scrollbar,
        #room-content::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #messages::-webkit-scrollbar-track,
        #room-content::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        #messages::-webkit-scrollbar-thumb,
        #room-content::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #667eea, #764ba2);
            border-radius: 4px;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 600px) {
            body { padding: 10px; }
            #chat-container { height: 98vh; border-radius: 16px; }
            .msg { max-width: 90%; }
            .header h1 { font-size: 18px; }
            .user-info { padding: 6px 12px; }
            .action-btn span:not(.emoji) { display: none; }
            .action-btn { padding: 12px; }
            .input-row { gap: 6px; }
            #messageInput { font-size: 14px; }
            .help-section { padding: 5px; }
        }

        /* ========== ANIMATIONS ========== */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.3s ease-in-out;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 20px;
            margin-bottom: 8px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: toastIn 0.3s ease-out;
        }

        @keyframes toastIn {
            from { bottom: 0; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }
    </style>
</head>
<body data-theme="default">
    <div id="chat-container">
        <!-- ========== AUTH SCREEN ========== -->
        <div id="auth-screen" style="display: flex; flex-direction: column; height: 100%;">
            <div class="header">
                <h1>üï≥Ô∏è BLACK HOLE V2</h1>
                <div style="display: flex; gap: 10px;">
                    <button id="notificationPermissionBtn" onclick="requestNotificationPermission()" class="notification-btn">
                        <span>üîî</span> <span>Enable Notifications</span>
                    </button>
                </div>
            </div>
            
            <div style="flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; background: rgba(15,15,15,0.95);">
                <div style="width: 100%; max-width: 400px;">
                    <!-- Login Form -->
                    <div id="loginForm" style="background: rgba(34,34,34,0.8); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; border: 1px solid #667eea; margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 20px; font-size: 18px; color: #fff; text-align: center;">üîê LOGIN</div>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <input id="loginUsername" placeholder="Username..." maxlength="30" style="background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 14px 18px; color: white; border-radius: 30px; outline: none; font-size: 15px;" />
                            <input id="loginPassword" placeholder="Password..." maxlength="30" type="password" style="background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 14px 18px; color: white; border-radius: 30px; outline: none; font-size: 15px;" />
                            <button onclick="handleLogin()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 14px; color: white; border-radius: 30px; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 16px;">üöÄ LOGIN</button>
                            <div style="text-align: center; color: #aaa; font-size: 14px;">Don't have an account? <span onclick="switchToRegister()" style="cursor: pointer; color: #667eea; text-decoration: underline;">Register</span></div>
                        </div>
                    </div>

                    <!-- Register Form -->
                    <div id="registerForm" style="display: none; background: rgba(34,34,34,0.8); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; border: 1px solid #667eea;">
                        <div style="font-weight: bold; margin-bottom: 20px; font-size: 18px; color: #fff; text-align: center;">üìù REGISTER</div>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <input id="regUsername" placeholder="Choose username..." maxlength="30" style="background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 14px 18px; color: white; border-radius: 30px; outline: none; font-size: 15px;" />
                            <input id="regPassword" placeholder="Choose password..." maxlength="30" type="password" style="background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 14px 18px; color: white; border-radius: 30px; outline: none; font-size: 15px;" />
                            <input id="regConfirmPassword" placeholder="Confirm password..." maxlength="30" type="password" style="background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 14px 18px; color: white; border-radius: 30px; outline: none; font-size: 15px;" />
                            <button onclick="handleRegister()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 14px; color: white; border-radius: 30px; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 16px;">‚ú® REGISTER</button>
                            <div style="text-align: center; color: #aaa; font-size: 14px;">Already have an account? <span onclick="switchToLogin()" style="cursor: pointer; color: #667eea; text-decoration: underline;">Login</span></div>
                        </div>
                    </div>
                    
                    <div id="authMessage" style="text-align: center; color: #ff6b6b; margin-top: 20px; font-size: 14px; display: none;"></div>
                </div>
            </div>
        </div>

        <!-- ========== ROOM SELECTION SCREEN ========== -->
        <div id="room-screen" style="display: none; flex-direction: column; height: 100%;">
            <div class="header" style="justify-content: space-between;">
                <h1>üï≥Ô∏è BLACK HOLE <span id="rank-indicator-header" style="display: none;"></span></h1>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div class="user-info">
                        <span class="status-dot"></span>
                        <span id="loggedInUsername">User</span>
                        <span id="rank-badge-header" style="display: none;"></span>
                    </div>
                    <button onclick="handleLogout()" class="action-btn danger" style="padding: 8px 16px;">
                        <span>üö™</span> LOGOUT
                    </button>
                </div>
            </div>
            
            <div id="room-content">
                <!-- Create Room Section -->
                <div class="room-card">
                    <div style="font-weight: bold; margin-bottom: 16px; font-size: 16px; color: #ccc;">üèóÔ∏è CREATE NEW ROOM</div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <input id="newRoomName" placeholder="Room name..." maxlength="30" style="background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 12px 16px; color: white; border-radius: 30px; outline: none; font-size: 14px;" />
                        <input id="newRoomPassword" placeholder="Password (optional)..." maxlength="30" type="password" style="background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 12px 16px; color: white; border-radius: 30px; outline: none; font-size: 14px;" />
                        <select id="roomTheme" style="background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 12px 16px; color: white; border-radius: 30px; outline: none; font-size: 14px;">
                            <option value="default">Default Theme</option>
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                            <option value="neon">Neon</option>
                            <option value="midnight">Midnight</option>
                            <option value="sunset">Sunset</option>
                            <option value="forest">Forest</option>
                            <option value="ocean">Ocean</option>
                            <option value="cyberpunk">Cyberpunk</option>
                            <option value="vintage">Vintage</option>
                        </select>
                        <button onclick="createRoom()" class="action-btn success" style="width: 100%;">
                            <span>‚ú®</span> CREATE ROOM
                        </button>
                    </div>
                </div>

                <!-- Available Rooms Section -->
                <div>
                    <div style="font-weight: bold; margin-bottom: 16px; font-size: 16px; color: #ccc;">üìã AVAILABLE ROOMS</div>
                    <div id="rooms-list" style="display: flex; flex-direction: column; gap: 12px;"></div>
                </div>
            </div>
        </div>

        <!-- ========== CHAT SCREEN ========== -->
        <div id="chat-screen" style="display: none; flex-direction: column; height: 100%;">
            <div class="header">
                <div>
                    <h1 style="margin-bottom: 4px;">
                        üï≥Ô∏è <span id="current-room">Room</span>
                        <span id="voice-indicator" class="voice-indicator" style="display: none;">
                            <span>üé§</span>
                            <div class="voice-wave">
                                <span></span><span></span><span></span>
                            </div>
                        </span>
                    </h1>
                    <div style="font-size: 13px; opacity: 0.8; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <span><span id="members-count">0</span> members</span>
                        <span id="room-theme-indicator" style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 12px;">üé® default</span>
                    </div>
                </div>
                <div class="user-info">
                    <span class="status-dot"></span>
                    <span id="username-display">User</span>
                    <span id="rank-badge-chat" style="display: none;"></span>
                </div>
            </div>
            
            <div id="messages"></div>
            
            <div id="input-area">
                <!-- Voice Chat Controls -->
                <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;" id="voice-controls">
                    <button onclick="toggleVoiceChat()" id="voiceBtn" class="action-btn" style="flex: 1; min-width: 120px;">
                        <span>üé§</span> <span id="voiceBtnText">JOIN VOICE</span>
                    </button>
                    <button onclick="showUserList()" id="userListBtn" class="action-btn" style="flex: 1; min-width: 100px;">
                        <span>üë•</span> USERS
                    </button>
                    <button onclick="showFileUpload()" id="fileUploadBtn" class="action-btn" style="flex: 1; min-width: 100px; display: none;">
                        <span>üìÅ</span> SHARE
                    </button>
                </div>

                <!-- Message Input -->
                <div class="input-row">
                    <input id="messageInput" placeholder="Type message... /help for commands" autocomplete="off">
                    <button class="action-btn" onclick="toggleEmojiPanel()" title="Emoji">üòä</button>
                    <button onclick="sendMessage()" class="action-btn success" style="min-width: 80px;">
                        <span>üì§</span> SEND
                    </button>
                </div>
                
                <!-- Emoji Panel -->
                <div class="emoji-panel" id="emojiPanel"></div>
                
                <!-- Room Actions -->
                <div class="input-row" style="margin-top: 12px;">
                    <button onclick="leaveRoom()" class="action-btn danger" style="flex: 1;">
                        <span>üö™</span> LEAVE
                    </button>
                    <button onclick="showPrivateMessages()" id="pmBtn" class="action-btn" style="flex: 1;">
                        <span>üíå</span> PM
                    </button>
                    <button onclick="showThemeSelector()" id="themeBtn" class="action-btn" style="flex: 1;">
                        <span>üé®</span> THEME
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODALS ========== -->

    <!-- User List Modal -->
    <div id="userListModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üë• Room Members</div>
                <button class="modal-close" onclick="closeModal('userListModal')">√ó</button>
            </div>
            <div class="modal-body" id="userListContent">
                <div style="text-align: center; color: #888; padding: 20px;">Loading users...</div>
            </div>
        </div>
    </div>

    <!-- Private Messages Modal -->
    <div id="privateMessagesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üíå Private Messages</div>
                <button class="modal-close" onclick="closeModal('privateMessagesModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <div style="margin-bottom: 10px;">
                        <select id="pmRecipientSelect" style="width: 100%; background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 12px; color: white; border-radius: 30px; margin-bottom: 10px;">
                            <option value="">Select user...</option>
                        </select>
                    </div>
                    <input type="text" id="pmRecipient" placeholder="Or type username..." style="width: 100%; background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 12px; color: white; border-radius: 30px; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="pmMessage" placeholder="Message..." style="flex: 1; background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 12px; color: white; border-radius: 30px;">
                        <button onclick="sendPrivateMessage()" class="action-btn success">SEND</button>
                    </div>
                </div>
                <div style="margin-bottom: 10px;">
                    <span style="color: #888; font-size: 12px;">üîí Private messages are visible to:</span>
                    <ul style="color: #aaa; font-size: 11px; margin-top: 5px; list-style: none;">
                        <li>üëë Owner - All messages</li>
                        <li>üëÆ Admin - Messages from Admin and below</li>
                        <li>üõ°Ô∏è Moderator - Messages from Mod and below</li>
                        <li>‚≠ê VIP - Only their own messages</li>
                        <li>üë§ Member - Only their own messages</li>
                    </ul>
                </div>
                <div id="privateMessagesList" style="max-height: 300px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                    <div style="text-align: center; color: #888; padding: 20px;">No messages yet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div id="fileUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìÅ Share File</div>
                <button class="modal-close" onclick="closeModal('fileUploadModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="border: 2px dashed #667eea; border-radius: 16px; padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìé</div>
                    <div style="color: #ccc;">Click to upload or drag and drop</div>
                    <div style="font-size: 12px; color: #888; margin-top: 10px;">Max size: 50MB (Images, PDF, Audio, Video, Text)</div>
                </div>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(this.files[0])">
                <div id="filePreview" style="display: none; background: rgba(102,126,234,0.1); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="fileIcon" style="font-size: 32px;">üìÑ</span>
                        <div style="flex: 1;">
                            <div id="fileName" style="font-weight: bold;"></div>
                            <div id="fileSize" style="font-size: 12px; color: #888;"></div>
                        </div>
                    </div>
                </div>
                <button onclick="uploadFile()" class="action-btn success" style="width: 100%;" id="uploadBtn">UPLOAD FILE</button>
            </div>
        </div>
    </div>

    <!-- Grant Rank Modal (Admin/Owner only) -->
    <div id="grantRankModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üëë Grant Rank</div>
                <button class="modal-close" onclick="closeModal('grantRankModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <input type="text" id="grantUsername" placeholder="Username..." style="width: 100%; background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 12px; color: white; border-radius: 30px; margin-bottom: 15px;">
                    <select id="grantRankSelect" style="width: 100%; background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 12px; color: white; border-radius: 30px; margin-bottom: 15px;">
                        <option value="moderator">üõ°Ô∏è Moderator</option>
                        <option value="vip">‚≠ê VIP</option>
                        <option value="member">üë§ Member</option>
                    </select>
                    <input type="password" id="grantPassword" placeholder="Admin Password (if not owner)" style="width: 100%; background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 12px; color: white; border-radius: 30px; margin-bottom: 15px;">
                    <button onclick="grantRank()" class="action-btn success" style="width: 100%;">GRANT RANK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Selector Modal -->
    <div id="themeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üé® Theme Selector</div>
                <button class="modal-close" onclick="closeModal('themeModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <select id="themeScope" style="width: 100%; background: rgba(51,51,51,0.8); border: 2px solid #444; padding: 12px; color: white; border-radius: 30px; margin-bottom: 15px;">
                        <option value="personal">Personal Theme</option>
                        <option value="room">Room Theme (VIP+)</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <button onclick="changeTheme('default')" class="action-btn">Default</button>
                    <button onclick="changeTheme('dark')" class="action-btn">Dark</button>
                    <button onclick="changeTheme('light')" class="action-btn">Light</button>
                    <button onclick="changeTheme('neon')" class="action-btn">Neon</button>
                    <button onclick="changeTheme('midnight')" class="action-btn">Midnight</button>
                    <button onclick="changeTheme('sunset')" class="action-btn">Sunset</button>
                    <button onclick="changeTheme('forest')" class="action-btn">Forest</button>
                    <button onclick="changeTheme('ocean')" class="action-btn">Ocean</button>
                    <button onclick="changeTheme('cyberpunk')" class="action-btn">Cyberpunk</button>
                    <button onclick="changeTheme('vintage')" class="action-btn">Vintage</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Effects Modal (Admin only) -->
    <div id="effectsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚ú® Effects Panel (Admin)</div>
                <button class="modal-close" onclick="closeModal('effectsModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <button onclick="triggerEffect('glitch')" class="action-btn">Glitch</button>
                    <button onclick="triggerEffect('flashbang')" class="action-btn">Flashbang</button>
                    <button onclick="triggerEffect('black')" class="action-btn">Blackout</button>
                    <button onclick="triggerEffect('hack')" class="action-btn">Hack</button>
                    <button onclick="triggerEffect('matrix')" class="action-btn">Matrix</button>
                    <button onclick="triggerEffect('rainbow')" class="action-btn">Rainbow</button>
                    <button onclick="triggerEffect('neon')" class="action-btn">Neon</button>
                    <button onclick="triggerEffect('firework')" class="action-btn">Firework</button>
                    <button onclick="triggerEffect('confetti')" class="action-btn">Confetti</button>
                    <button onclick="triggerEffect('gameroom')" class="action-btn">Game Room</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" style="display: none;"></div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // ========== BLACK HOLE CHAT V2 - FULL CLIENT ==========
        
        // Socket.IO connection
        const socket = io();
        
        // ========== GLOBAL VARIABLES ==========
        let currentUsername = 'User';
        let currentRoom = null;
        let currentRank = 'member';
        let currentTheme = 'default';
        let isAdmin = false;
        let isModerator = false;
        let isVip = false;
        let isOwner = false;
        
        // Voice chat
        let voiceChat = null;
        let isVoiceActive = false;
        let peerConnections = {};
        let localStream = null;
        
        // File upload
        let selectedFile = null;
        
        // Private messages
        let privateMessages = [];
        let onlineUsers = [];
        
        // Browser notifications
        let notificationsEnabled = false;
        let notificationPermission = false;
        
        // UI Elements
        const msgContainer = document.getElementById('messages');
        const input = document.getElementById('messageInput');
        const emojiPanel = document.getElementById('emojiPanel');
        const authScreen = document.getElementById('auth-screen');
        const roomScreen = document.getElementById('room-screen');
        const chatScreen = document.getElementById('chat-screen');
        const roomsList = document.getElementById('rooms-list');
        const usernameDisplay = document.getElementById('username-display');
        const loggedInUsernameDisplay = document.getElementById('loggedInUsername');
        const authMessage = document.getElementById('authMessage');
        const toast = document.getElementById('toast');
        
        // ========== RANK LEVELS ==========
        const RANK_LEVELS = {
            'owner': 1,
            'admin': 2,
            'moderator': 3,
            'vip': 4,
            'member': 5
        };
        
        function getRankLevel(rank) {
            return RANK_LEVELS[rank] || 5;
        }
        
        function canSeePrivateMessage(senderRank, viewerRank) {
            const senderLevel = getRankLevel(senderRank);
            const viewerLevel = getRankLevel(viewerRank);
            // Higher ranks (lower numbers) can see messages from lower ranks
            return viewerLevel <= senderLevel;
        }
        
        // ========== BROWSER NOTIFICATIONS ==========
        
        // Check if browser supports notifications
        function checkNotificationSupport() {
            if (!("Notification" in window)) {
                console.log("This browser does not support desktop notification");
                return false;
            }
            return true;
        }
        
        // Request notification permission
        function requestNotificationPermission() {
            if (!checkNotificationSupport()) {
                showToast("‚ùå Your browser doesn't support notifications");
                return;
            }
            
            Notification.requestPermission().then(permission => {
                notificationPermission = permission === 'granted';
                const btn = document.getElementById('notificationPermissionBtn');
                
                if (notificationPermission) {
                    notificationsEnabled = true;
                    btn.classList.add('enabled');
                    btn.innerHTML = '<span>üîî</span> <span>Notifications Enabled</span>';
                    showToast("‚úÖ Notifications enabled!");
                    
                    // Send a test notification
                    sendNotification('‚úÖ Notifications Enabled', 'You will now receive notifications for new messages');
                } else {
                    notificationsEnabled = false;
                    btn.classList.remove('enabled');
                    btn.innerHTML = '<span>üîï</span> <span>Enable Notifications</span>';
                    showToast("‚ùå Notifications blocked");
                }
            });
        }
        
        // Send browser notification
        function sendNotification(title, body, icon = 'üï≥Ô∏è') {
            if (!notificationPermission || document.hidden === false) {
                // Don't send notification if tab is active
                return;
            }
            
            try {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#667eea" opacity="0.3"/><text x="50" y="70" font-size="50" text-anchor="middle" fill="white">üï≥Ô∏è</text></svg>'),
                    badge: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#667eea" opacity="0.3"/><text x="50" y="70" font-size="50" text-anchor="middle" fill="white">üí¨</text></svg>'),
                    tag: 'chat-message',
                    renotify: true,
                    silent: false
                });
                
                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
                
                setTimeout(() => notification.close(), 5000);
                
            } catch (err) {
                console.error('Notification error:', err);
            }
        }
        
        // ========== EMOJIS ==========
        const emojis = ['üòÄ', 'üòÇ', 'üòç', 'ü•∞', 'üòé', 'ü§î', 'üò¢', 'üéâ', 'üëç', '‚ù§Ô∏è', 'üî•', '‚ú®', 'üåü', 'üíØ', 'üò±', 'ü§Ø', 'üéä', 'üéà', 'üöÄ', 'üí™', 'üòò', 'üôè', 'üëè', 'üéµ', 'üçï', 'üçî', 'üçâ', 'üéÆ', 'üëæ', 'ü§ñ', 'üëΩ', 'üíÄ', 'üëë', '‚ö°', 'üåä', 'üåà', '‚òÑÔ∏è', 'üï≥Ô∏è', 'üåÄ', 'üé≠', 'üé™', 'üé®', 'üé§', 'üìÅ', 'üíå', 'üîí', 'üîì', '‚è∞', '‚åõ', 'üíæ', 'üìÄ', 'üíø', '‚ò†Ô∏è'];
        
        // Load emojis
        function loadEmojis() {
            emojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.onclick = () => {
                    input.value += emoji;
                    input.focus();
                    emojiPanel.classList.remove('show');
                };
                emojiPanel.appendChild(emojiItem);
            });
        }
        loadEmojis();
        
        function toggleEmojiPanel() {
            emojiPanel.classList.toggle('show');
            input.focus();
        }
        
        // ========== UTILITY FUNCTIONS ==========
        
        function showToast(message, duration = 3000) {
            toast.style.display = 'block';
            toast.className = 'toast';
            toast.textContent = message;
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }
        
        function getRankBadge(rank) {
            const rankMap = {
                'owner': { class: 'rank-owner', text: 'OWNER' },
                'admin': { class: 'rank-admin', text: 'ADMIN' },
                'moderator': { class: 'rank-moderator', text: 'MOD' },
                'vip': { class: 'rank-vip', text: 'VIP' },
                'member': { class: 'rank-member', text: 'MEMBER' }
            };
            const rankInfo = rankMap[rank] || rankMap.member;
            return `<span class="${rankInfo.class}">${rankInfo.text}</span>`;
        }
        
        function updateRankUI(rank) {
            currentRank = rank;
            isOwner = rank === 'owner';
            isAdmin = rank === 'admin' || rank === 'owner';
            isModerator = rank === 'moderator' || rank === 'admin' || rank === 'owner';
            isVip = rank === 'vip' || rank === 'moderator' || rank === 'admin' || rank === 'owner';
            
            // Update rank badges
            const badgeHeader = document.getElementById('rank-badge-header');
            const badgeChat = document.getElementById('rank-badge-chat');
            const rankIndicator = document.getElementById('rank-indicator-header');
            
            if (badgeHeader) badgeHeader.innerHTML = getRankBadge(rank);
            if (badgeChat) badgeChat.innerHTML = getRankBadge(rank);
            if (rankIndicator) rankIndicator.innerHTML = getRankBadge(rank);
            
            // Show/hide file upload button based on rank
            const fileUploadBtn = document.getElementById('fileUploadBtn');
            if (fileUploadBtn) {
                fileUploadBtn.style.display = isVip ? 'flex' : 'none';
            }
            
            // Show grant rank button for admin/owner
            const existingGrantBtn = document.getElementById('grantRankBtn');
            if ((isAdmin || isOwner) && !existingGrantBtn) {
                const grantBtn = document.createElement('button');
                grantBtn.id = 'grantRankBtn';
                grantBtn.className = 'action-btn success';
                grantBtn.style.padding = '8px 16px';
                grantBtn.innerHTML = '<span>üëë</span> GRANT';
                grantBtn.onclick = () => showModal('grantRankModal');
                document.querySelector('.header .user-info').after(grantBtn);
            } else if (!isAdmin && !isOwner && existingGrantBtn) {
                existingGrantBtn.remove();
            }
            
            // Show effects button for admin/owner
            const existingEffectsBtn = document.getElementById('effectsBtn');
            if ((isAdmin || isOwner) && !existingEffectsBtn) {
                const effectsBtn = document.createElement('button');
                effectsBtn.id = 'effectsBtn';
                effectsBtn.className = 'action-btn';
                effectsBtn.style.padding = '8px 16px';
                effectsBtn.innerHTML = '<span>‚ú®</span> EFFECTS';
                effectsBtn.onclick = () => showModal('effectsModal');
                document.querySelector('.header .user-info').after(effectsBtn);
            } else if (!isAdmin && !isOwner && existingEffectsBtn) {
                existingEffectsBtn.remove();
            }
        }
        
        // ========== VOICE CHAT ==========
        
        class VoiceChatHandler {
            constructor(socket, roomName, username) {
                this.socket = socket;
                this.roomName = roomName;
                this.username = username;
                this.localStream = null;
                this.peerConnections = {};
                this.isActive = false;
                
                this.configuration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' },
                        {
                            urls: 'turn:openrelay.metered.ca:80',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        },
                        {
                            urls: 'turn:openrelay.metered.ca:443',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        }
                    ]
                };
            }
            
            async start() {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }, 
                        video: false 
                    });
                    this.isActive = true;
                    
                    this.socket.emit('join_voice', { 
                        roomName: this.roomName,
                        username: this.username 
                    });
                    
                    this.socket.on('user_joined_voice', (data) => this.handleUserJoined(data));
                    this.socket.on('user_left_voice', (data) => this.handleUserLeft(data));
                    this.socket.on('voice_offer', (data) => this.handleVoiceOffer(data));
                    this.socket.on('voice_answer', (data) => this.handleVoiceAnswer(data));
                    this.socket.on('ice_candidate', (data) => this.handleIceCandidate(data));
                    
                    document.getElementById('voice-indicator').style.display = 'flex';
                    document.getElementById('voiceBtnText').textContent = 'LEAVE VOICE';
                    document.getElementById('voiceBtn').classList.add('danger');
                    
                    showToast('üé§ Joined voice chat');
                    return true;
                    
                } catch (err) {
                    console.error('Voice chat error:', err);
                    showToast('‚ùå Could not access microphone');
                    return false;
                }
            }
            
            stop() {
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    this.localStream = null;
                }
                
                Object.values(this.peerConnections).forEach(pc => pc.close());
                this.peerConnections = {};
                this.isActive = false;
                
                this.socket.emit('leave_voice', { roomName: this.roomName });
                this.socket.off('user_joined_voice');
                this.socket.off('user_left_voice');
                this.socket.off('voice_offer');
                this.socket.off('voice_answer');
                this.socket.off('ice_candidate');
                
                document.getElementById('voice-indicator').style.display = 'none';
                document.getElementById('voiceBtnText').textContent = 'JOIN VOICE';
                document.getElementById('voiceBtn').classList.remove('danger');
                
                showToast('üé§ Left voice chat');
            }
            
            handleUserJoined(data) {
                addSystemMessage(`üé§ ${data.username} joined voice chat`);
                this.createPeerConnection(data.userId);
            }
            
            handleUserLeft(data) {
                addSystemMessage(`üé§ ${data.username || 'A user'} left voice chat`);
                if (this.peerConnections[data.userId]) {
                    this.peerConnections[data.userId].close();
                    delete this.peerConnections[data.userId];
                }
            }
            
            async createPeerConnection(targetId) {
                try {
                    const pc = new RTCPeerConnection(this.configuration);
                    this.peerConnections[targetId] = pc;
                    
                    this.localStream.getTracks().forEach(track => {
                        pc.addTrack(track, this.localStream);
                    });
                    
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            this.socket.emit('ice_candidate', {
                                target: targetId,
                                candidate: event.candidate
                            });
                        }
                    };
                    
                    pc.ontrack = (event) => {
                        const audio = document.createElement('audio');
                        audio.srcObject = event.streams[0];
                        audio.autoplay = true;
                        audio.controls = false;
                        document.body.appendChild(audio);
                        
                        event.streams[0].oninactive = () => {
                            audio.remove();
                        };
                    };
                    
                    const offer = await pc.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: false
                    });
                    await pc.setLocalDescription(offer);
                    
                    this.socket.emit('voice_offer', {
                        target: targetId,
                        offer: offer,
                        roomName: this.roomName
                    });
                    
                    return pc;
                    
                } catch (err) {
                    console.error('Create peer connection error:', err);
                }
            }
            
            async handleVoiceOffer(data) {
                try {
                    const pc = new RTCPeerConnection(this.configuration);
                    this.peerConnections[data.from] = pc;
                    
                    this.localStream.getTracks().forEach(track => {
                        pc.addTrack(track, this.localStream);
                    });
                    
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            this.socket.emit('ice_candidate', {
                                target: data.from,
                                candidate: event.candidate
                            });
                        }
                    };
                    
                    pc.ontrack = (event) => {
                        const audio = document.createElement('audio');
                        audio.srcObject = event.streams[0];
                        audio.autoplay = true;
                        audio.controls = false;
                        document.body.appendChild(audio);
                        
                        event.streams[0].oninactive = () => {
                            audio.remove();
                        };
                    };
                    
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    
                    this.socket.emit('voice_answer', {
                        target: data.from,
                        answer: answer
                    });
                    
                } catch (err) {
                    console.error('Handle voice offer error:', err);
                }
            }
            
            async handleVoiceAnswer(data) {
                try {
                    const pc = this.peerConnections[data.from];
                    if (pc) {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                } catch (err) {
                    console.error('Handle voice answer error:', err);
                }
            }
            
            handleIceCandidate(data) {
                try {
                    const pc = this.peerConnections[data.from];
                    if (pc) {
                        pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                } catch (err) {
                    console.error('Handle ICE candidate error:', err);
                }
            }
        }
        
        // ========== VOICE CHAT CONTROLS ==========
        
        async function toggleVoiceChat() {
            if (!currentRoom) {
                showToast('‚ùå Join a room first');
                return;
            }
            
            if (!voiceChat || !isVoiceActive) {
                voiceChat = new VoiceChatHandler(socket, currentRoom, currentUsername);
                const success = await voiceChat.start();
                if (success) {
                    isVoiceActive = true;
                }
            } else {
                voiceChat.stop();
                isVoiceActive = false;
                voiceChat = null;
            }
        }
        
        // ========== FILE UPLOAD ==========
        
        function showFileUpload() {
            if (!isVip) {
                showToast('‚ùå VIP+ only can share files');
                return;
            }
            showModal('fileUploadModal');
        }
        
        function handleFileSelect(file) {
            if (!file) return;
            
            // Check file size (50MB limit)
            if (file.size > 50 * 1024 * 1024) {
                showToast('‚ùå File too large! Max 50MB');
                return;
            }
            
            selectedFile = file;
            
            // Update preview
            let icon = 'üìÑ';
            if (file.type.startsWith('image/')) icon = 'üñºÔ∏è';
            else if (file.type === 'application/pdf') icon = 'üìï';
            else if (file.type.startsWith('audio/')) icon = 'üéµ';
            else if (file.type.startsWith('video/')) icon = 'üé¨';
            
            document.getElementById('fileIcon').textContent = icon;
            document.getElementById('fileName').textContent = file.name;
            
            let sizeText = '';
            if (file.size < 1024) sizeText = `${file.size} B`;
            else if (file.size < 1024 * 1024) sizeText = `${(file.size / 1024).toFixed(1)} KB`;
            else sizeText = `${(file.size / (1024 * 1024)).toFixed(1)} MB`;
            
            document.getElementById('fileSize').textContent = sizeText;
            document.getElementById('filePreview').style.display = 'block';
        }
        
        async function uploadFile() {
            if (!selectedFile) {
                showToast('‚ùå Please select a file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('username', currentUsername);
            formData.append('roomName', currentRoom || '');
            
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadBtn').innerHTML = '<span>‚è≥</span> UPLOADING...';
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    socket.emit('share_file', {
                        fileUrl: result.fileUrl,
                        fileName: result.fileName,
                        fileType: result.fileType,
                        fileSize: result.fileSize
                    });
                    closeModal('fileUploadModal');
                    showToast(`‚úÖ File shared: ${result.fileName}`);
                } else {
                    showToast('‚ùå Upload failed: ' + (result.error || 'Unknown error'));
                }
                
            } catch (err) {
                console.error('Upload error:', err);
                showToast('‚ùå Upload failed');
            } finally {
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').innerHTML = '<span>üì§</span> UPLOAD FILE';
                selectedFile = null;
                document.getElementById('filePreview').style.display = 'none';
            }
        }
        
        // ========== AUTH UI ==========
        
        function switchToRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            authMessage.style.display = 'none';
        }
        
        function switchToLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            authMessage.style.display = 'none';
        }
        
        function showAuthMessage(msg, isError = true) {
            authMessage.textContent = msg;
            authMessage.style.color = isError ? '#ff6b6b' : '#4ade80';
            authMessage.style.display = 'block';
            setTimeout(() => {
                authMessage.style.display = 'none';
            }, 3000);
        }
        
        // ========== AUTH HANDLERS ==========
        
        function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showAuthMessage('Please enter both username and password');
                return;
            }
            
            socket.emit('login', { username, password });
        }
        
        function handleRegister() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            if (!username || !password || !confirmPassword) {
                showAuthMessage('Please fill in all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthMessage('Passwords do not match');
                return;
            }
            
            if (password.length < 4) {
                showAuthMessage('Password must be at least 4 characters');
                return;
            }
            
            socket.emit('register', { username, password });
        }
        
        function handleLogout() {
            if (currentRoom) {
                socket.emit('leave_room');
            }
            if (isVoiceActive && voiceChat) {
                voiceChat.stop();
                isVoiceActive = false;
            }
            socket.emit('logout');
            resetUI();
        }
        
        function resetUI() {
            currentUsername = 'User';
            currentRoom = null;
            currentRank = 'member';
            isAdmin = false;
            isModerator = false;
            isVip = false;
            isOwner = false;
            
            authScreen.style.display = 'flex';
            roomScreen.style.display = 'none';
            chatScreen.style.display = 'none';
            switchToLogin();
            
            const grantBtn = document.getElementById('grantRankBtn');
            if (grantBtn) grantBtn.remove();
            
            const effectsBtn = document.getElementById('effectsBtn');
            if (effectsBtn) effectsBtn.remove();
        }
        
        // ========== SOCKET AUTH EVENTS ==========
        
        socket.on('auth_success', (data) => {
            currentUsername = data.username;
            updateRankUI(data.rank);
            
            loggedInUsernameDisplay.textContent = data.username;
            usernameDisplay.textContent = data.username;
            
            if (data.theme) {
                changeTheme(data.theme, 'personal');
            }
            
            showAuthMessage(data.message, false);
            setTimeout(() => {
                authScreen.style.display = 'none';
                roomScreen.style.display = 'flex';
                loadRooms();
            }, 500);
            
            showToast(`‚úÖ Welcome, ${data.username}!`);
        });
        
        socket.on('auth_error', (data) => {
            showAuthMessage(data.message);
        });
        
        socket.on('logged_out', () => {
            resetUI();
            showToast('üëã Logged out');
        });
        
        socket.on('rank_changed', (data) => {
            updateRankUI(data.newRank);
            showToast(`üëë Your rank is now ${data.newRank.toUpperCase()}`);
        });
        
        // ========== ROOMS ==========
        
        function loadRooms() {
            socket.emit('get_rooms');
        }
        
        socket.on('rooms_list', (rooms) => {
            roomsList.innerHTML = '';
            
            if (rooms.length === 0) {
                roomsList.innerHTML = '<div style="text-align: center; color: #888; padding: 40px;">No rooms available. Create one!</div>';
                return;
            }
            
            rooms.sort((a, b) => {
                if (a.isDefault) return -1;
                if (b.isDefault) return 1;
                return a.name.localeCompare(b.name);
            });
            
            rooms.forEach(room => {
                const roomCard = document.createElement('div');
                roomCard.className = 'room-card';
                
                let lockIcon = room.hasPassword ? 'üîí' : 'üîì';
                let defaultBadge = room.isDefault ? '<span class="rank-owner" style="margin-left: 8px;">DEFAULT</span>' : '';
                
                roomCard.innerHTML = `
                    <div class="room-header">
                        <div class="room-name">
                            <span>${lockIcon}</span>
                            ${room.name}
                            ${defaultBadge}
                            <span style="font-size: 12px; color: #888; margin-left: 8px;">üé® ${room.theme || 'default'}</span>
                        </div>
                        <div class="room-stats">
                            <span>üë• ${room.members}</span>
                        </div>
                    </div>
                    <div class="room-actions">
                        <button onclick="joinRoom('${room.name}')" class="action-btn success" style="flex: 1;">
                            <span>üö™</span> JOIN
                        </button>
                        ${!room.isDefault && (isAdmin || isOwner) ? `
                            <button onclick="deleteRoom('${room.name}')" class="action-btn danger">
                                <span>üóëÔ∏è</span> DEL
                            </button>
                        ` : ''}
                    </div>
                `;
                
                roomsList.appendChild(roomCard);
            });
        });
        
        function createRoom() {
            const roomName = document.getElementById('newRoomName').value.trim();
            const password = document.getElementById('newRoomPassword').value;
            const theme = document.getElementById('roomTheme').value;
            
            if (!roomName) {
                showToast('‚ùå Please enter a room name');
                return;
            }
            
            if (roomName.length < 2) {
                showToast('‚ùå Room name too short');
                return;
            }
            
            socket.emit('create_room', { roomName, password, theme });
            
            document.getElementById('newRoomName').value = '';
            document.getElementById('newRoomPassword').value = '';
        }
        
        function joinRoom(roomName) {
            socket.emit('join_room', { roomName, password: '' });
        }
        
        function deleteRoom(roomName) {
            if (confirm(`Are you sure you want to delete "${roomName}"?`)) {
                if (isAdmin || isOwner) {
                    socket.emit('delete_room', { roomName, password: '' });
                } else {
                    const password = prompt('Enter admin password:');
                    if (password) {
                        socket.emit('delete_room', { roomName, password });
                    }
                }
            }
        }
        
        socket.on('room_created', (data) => {
            loadRooms();
            showToast(`üè† Room "${data.name}" created`);
        });
        
        socket.on('room_deleted', (data) => {
            loadRooms();
            if (currentRoom === data.name) {
                leaveRoom();
            }
            showToast(`üóëÔ∏è Room "${data.name}" deleted`);
        });
        
        socket.on('joined_room', (data) => {
            currentRoom = data.roomName;
            usernameDisplay.textContent = data.username;
            document.getElementById('current-room').textContent = data.roomName;
            document.getElementById('members-count').textContent = '1';
            document.getElementById('room-theme-indicator').innerHTML = `üé® ${data.theme || 'default'}`;
            
            msgContainer.innerHTML = '';
            roomScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            input.focus();
            
            if (isVip && data.theme) {
                changeTheme(data.theme, 'personal');
            }
            
            showToast(`üö™ Joined room: ${data.roomName}`);
        });
        
        socket.on('room_history', (data) => {
            msgContainer.innerHTML = '';
            
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    if (msg.isPrivate) {
                        const shouldShow = canSeePrivateMessage(msg.senderRank || 'member', currentRank);
                        if (shouldShow || msg.username === currentUsername || msg.recipient === currentUsername) {
                            addPrivateMessage(msg.username, msg.message, msg.recipient, msg.username === currentUsername);
                        }
                    } else if (msg.fileUrl) {
                        addFileMessage(msg.username, msg.fileUrl, msg.fileName, msg.fileType, msg.fileSize);
                    } else {
                        addMessage(msg.username, msg.message, msg.rank);
                    }
                });
            }
            
            setTimeout(() => {
                msgContainer.scrollTop = msgContainer.scrollHeight;
            }, 100);
        });
        
        socket.on('user_joined', (data) => {
            document.getElementById('members-count').textContent = data.members;
            addSystemMessage(`üëã ${data.username} (${data.rank || 'member'}) joined`);
            
            // Send notification
            sendNotification('üëã User Joined', `${data.username} joined the room`);
            
            updateOnlineUsers();
        });
        
        socket.on('user_left', (data) => {
            document.getElementById('members-count').textContent = data.members;
            if (data.username) {
                addSystemMessage(`üëã ${data.username} left`);
            }
            
            updateOnlineUsers();
        });
        
        // ========== MESSAGES ==========
        
        socket.on('chat message', (data) => {
            if (data.fileUrl) {
                addFileMessage(data.username, data.fileUrl, data.fileName, data.fileType, data.fileSize);
            } else {
                addMessage(data.username, data.message, data.rank);
            }
            
            // Send notification for new messages (if not from self)
            if (data.username !== currentUsername && currentRoom) {
                sendNotification(`üí¨ New message in ${currentRoom}`, `${data.username}: ${data.message.substring(0, 50)}${data.message.length > 50 ? '...' : ''}`);
            }
        });
        
        function addMessage(username, message, rank = 'member') {
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            if (username === currentUsername) {
                wrapper.classList.add('mine');
            }
            
            const header = document.createElement('div');
            header.className = 'msg-header';
            
            let rankBadge = '';
            if (rank && rank !== 'member' && rank !== 'system') {
                rankBadge = getRankBadge(rank);
            }
            
            header.innerHTML = `
                <span class="msg-username">${username}</span>
                ${rankBadge}
                <span class="msg-timestamp">${new Date().toLocaleTimeString()}</span>
            `;
            wrapper.appendChild(header);
            
            const item = document.createElement('div');
            item.className = 'msg';
            if (username === currentUsername) item.classList.add('mine');
            if (username === 'System') item.classList.add('system');
            item.textContent = message;
            wrapper.appendChild(item);
            
            msgContainer.appendChild(wrapper);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }
        
        function addSystemMessage(message) {
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            
            const item = document.createElement('div');
            item.className = 'msg system';
            item.textContent = message;
            wrapper.appendChild(item);
            
            msgContainer.appendChild(wrapper);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }
        
        function addPrivateMessage(from, message, to, isFromSelf = false, isAdminView = false) {
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            
            const header = document.createElement('div');
            header.className = 'msg-header';
            
            let viewBadge = '';
            if (isAdminView) {
                viewBadge = '<span class="admin-view-badge">admin view</span>';
            }
            
            header.innerHTML = `
                <span class="msg-username">üîí ${from} ‚Üí ${to}</span>
                ${viewBadge}
                <span class="msg-timestamp">${new Date().toLocaleTimeString()}</span>
                ${isFromSelf ? '<span style="color: #4ade80; font-size: 10px;">(sent)</span>' : ''}
            `;
            wrapper.appendChild(header);
            
            const item = document.createElement('div');
            item.className = 'msg private';
            item.textContent = message;
            wrapper.appendChild(item);
            
            msgContainer.appendChild(wrapper);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }
        
        function addFileMessage(username, fileUrl, fileName, fileType, fileSize) {
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            if (username === currentUsername) wrapper.classList.add('mine');
            
            const header = document.createElement('div');
            header.className = 'msg-header';
            header.innerHTML = `
                <span class="msg-username">${username}</span>
                <span class="msg-timestamp">${new Date().toLocaleTimeString()}</span>
            `;
            wrapper.appendChild(header);
            
            const item = document.createElement('div');
            item.className = 'msg file-share';
            
            let icon = 'üìÑ';
            if (fileType?.startsWith('image/')) icon = 'üñºÔ∏è';
            else if (fileType === 'application/pdf') icon = 'üìï';
            else if (fileType?.startsWith('audio/')) icon = 'üéµ';
            else if (fileType?.startsWith('video/')) icon = 'üé¨';
            
            let sizeText = '';
            if (fileSize) {
                if (fileSize < 1024) sizeText = `${fileSize} B`;
                else if (fileSize < 1024 * 1024) sizeText = `${(fileSize / 1024).toFixed(1)} KB`;
                else sizeText = `${(fileSize / (1024 * 1024)).toFixed(1)} MB`;
            }
            
            item.innerHTML = `
                <div class="file-info" onclick="window.open('${fileUrl}', '_blank')">
                    <span class="file-icon">${icon}</span>
                    <div style="flex: 1;">
                        <div class="file-name">${fileName}</div>
                        ${sizeText ? `<div style="font-size: 10px; color: #888;">${sizeText}</div>` : ''}
                    </div>
                    <span style="font-size: 20px;">üì•</span>
                </div>
            `;
            wrapper.appendChild(item);
            
            msgContainer.appendChild(wrapper);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }
        
        function sendMessage() {
            if (input.value.trim()) {
                const messageText = input.value;
                
                if (messageText.startsWith('/')) {
                    handleCommand(messageText);
                    input.value = '';
                    emojiPanel.classList.remove('show');
                    return;
                }
                
                socket.emit('chat message', { 
                    username: currentUsername, 
                    message: messageText 
                });
                
                addMessage(currentUsername, messageText, currentRank);
                input.value = '';
                emojiPanel.classList.remove('show');
            }
        }
        
        // ========== FIXED HELP COMMAND ==========
        
        function showHelp() {
            const helpDiv = document.createElement('div');
            helpDiv.className = 'msg system help-menu';
            
            const rankLevel = getRankLevel(currentRank);
            
            helpDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <span style="font-size: 20px;">üï≥Ô∏è</span>
                    <span style="font-weight: bold; font-size: 18px; color: gold;"> BLACK HOLE CHAT V2</span>
                    <span style="font-size: 20px;">üï≥Ô∏è</span>
                </div>
                
                <div class="help-section">
                    <div class="help-title">üìã YOUR RANK</div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        ${getRankBadge(currentRank)}
                        <span style="color: #4ade80;">Level ${rankLevel}/5</span>
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-title">üí¨ EVERYONE</div>
                    <div><span class="help-command">/help</span> <span class="help-desc">- Show this help menu</span></div>
                    <div><span class="help-command">/users</span> <span class="help-desc">- List users in current room</span></div>
                    <div><span class="help-command">/msg &lt;user&gt; &lt;text&gt;</span> <span class="help-desc">- Send private message</span></div>
                    <div><span class="help-command">/flip</span> <span class="help-desc">- Flip a coin (heads/tails)</span></div>
                    <div><span class="help-command">/roll &lt;min&gt; &lt;max&gt;</span> <span class="help-desc">- Roll a random number</span></div>
                    <div><span class="help-command">/ping</span> <span class="help-desc">- Check connection latency</span></div>
                </div>
                
                <div class="help-section">
                    <div class="help-title">üìä RANK SYSTEM</div>
                    <div><span class="help-rank owner">OWNER</span> <span class="help-desc">- Can see ALL private messages</span></div>
                    <div><span class="help-rank admin">ADMIN</span> <span class="help-desc">- Can see messages from rank 2-5</span></div>
                    <div><span class="help-rank mod">MOD</span> <span class="help-desc">- Can see messages from rank 3-5</span></div>
                    <div><span class="help-rank vip">VIP</span> <span class="help-desc">- Can see only their own messages</span></div>
                    <div><span class="help-rank member">MEMBER</span> <span class="help-desc">- Can see only their own messages</span></div>
                </div>
                
                ${isVip ? `
                <div class="help-section">
                    <div class="help-title">‚≠ê VIP+ COMMANDS</div>
                    <div><span class="help-command">/theme &lt;name&gt;</span> <span class="help-desc">- Change theme (dark, neon, ocean, etc)</span></div>
                </div>
                ` : ''}
                
                ${isModerator ? `
                <div class="help-section">
                    <div class="help-title">üõ°Ô∏è MODERATOR+ COMMANDS</div>
                    <div><span class="help-command">/clear</span> <span class="help-desc">- Clear all messages in room</span></div>
                    <div><span class="help-command">/ban &lt;user&gt; [duration]</span> <span class="help-desc">- Ban user (10m, 1h, 1d)</span></div>
                </div>
                ` : ''}
                
                ${isAdmin ? `
                <div class="help-section">
                    <div class="help-title">üëÆ ADMIN+ COMMANDS</div>
                    <div><span class="help-command">/unban &lt;user&gt;</span> <span class="help-desc">- Unban user</span></div>
                    <div><span class="help-command">/delete &lt;room&gt;</span> <span class="help-desc">- Delete any room</span></div>
                    <div><span class="help-command">/grant &lt;user&gt; &lt;rank&gt;</span> <span class="help-desc">- Grant mod/vip/member</span></div>
                </div>
                ` : ''}
                
                ${isOwner ? `
                <div class="help-section">
                    <div class="help-title">üëë OWNER COMMANDS</div>
                    <div><span class="help-command">/grant &lt;user&gt; admin</span> <span class="help-desc">- Grant admin rank</span></div>
                </div>
                ` : ''}
                
                ${isAdmin || isOwner ? `
                <div class="help-section">
                    <div class="help-title">üéÆ EFFECT COMMANDS (ADMIN+)</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;">
                        <div><span class="help-command">/effect glitch</span> <span class="help-desc">- Glitch</span></div>
                        <div><span class="help-command">/effect flashbang</span> <span class="help-desc">- Flash</span></div>
                        <div><span class="help-command">/effect black</span> <span class="help-desc">- Blackout</span></div>
                        <div><span class="help-command">/effect hack</span> <span class="help-desc">- Hacker</span></div>
                        <div><span class="help-command">/effect matrix</span> <span class="help-desc">- Matrix</span></div>
                        <div><span class="help-command">/effect rainbow</span> <span class="help-desc">- Rainbow</span></div>
                        <div><span class="help-command">/effect neon</span> <span class="help-desc">- Neon</span></div>
                        <div><span class="help-command">/effect firework</span> <span class="help-desc">- Fireworks</span></div>
                        <div><span class="help-command">/effect confetti</span> <span class="help-desc">- Confetti</span></div>
                    </div>
                </div>
                ` : ''}
                
                <div style="text-align: center; margin-top: 15px; color: #888; font-size: 11px;">
                    üîî Click the notification button to enable browser notifications
                </div>
            `;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            wrapper.appendChild(helpDiv);
            msgContainer.appendChild(wrapper);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }
        
        // ========== PRIVATE MESSAGES ==========
        
        function showPrivateMessages() {
            showModal('privateMessagesModal');
            loadPrivateMessageHistory();
            updateOnlineUsersList();
        }
        
        function updateOnlineUsersList() {
            const select = document.getElementById('pmRecipientSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select user...</option>';
            
            socket.emit('get_room_users', { roomName: currentRoom });
        }
        
        socket.on('room_users', (data) => {
            onlineUsers = data.users.filter(u => u.username !== currentUsername);
            
            const select = document.getElementById('pmRecipientSelect');
            if (select) {
                onlineUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.innerHTML = `${user.username} ${getRankBadge(user.rank)}`;
                    select.appendChild(option);
                });
            }
            
            // Update user list modal if open
            updateUserListModal(data.users);
        });
        
        function updateUserListModal(users) {
            const content = document.getElementById('userListContent');
            if (!content) return;
            
            let html = '';
            users.forEach(user => {
                const userLevel = getRankLevel(user.rank);
                const currentUserLevel = getRankLevel(currentRank);
                
                html += `
                    <div class="user-list-item">
                        <div class="user-info-modal">
                            <span>${user.username}</span>
                            ${getRankBadge(user.rank)}
                            <span style="font-size: 10px; color: #888;">Lv${userLevel}</span>
                        </div>
                        <div class="user-actions">
                            ${(isModerator && userLevel > currentUserLevel) ? `
                                <button class="action-btn danger" style="padding: 4px 8px; font-size: 12px;" onclick="quickBan('${user.username}')">‚õî</button>
                            ` : ''}
                            <button class="action-btn" style="padding: 4px 8px; font-size: 12px;" onclick="quickMsg('${user.username}')">üíå</button>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html || '<div style="text-align: center; color: #888; padding: 20px;">No users in room</div>';
        }
        
        function sendPrivateMessage() {
            const recipient = document.getElementById('pmRecipient').value.trim() || 
                             document.getElementById('pmRecipientSelect').value;
            const message = document.getElementById('pmMessage').value.trim();
            
            if (!recipient || !message) {
                showToast('‚ùå Please enter recipient and message');
                return;
            }
            
            if (recipient === currentUsername) {
                showToast('‚ùå Cannot send private message to yourself');
                return;
            }
            
            socket.emit('private_message', {
                recipient,
                message,
                senderRank: currentRank,
                senderRankLevel: getRankLevel(currentRank)
            });
            
            document.getElementById('pmMessage').value = '';
            
            addPrivateMessage(currentUsername, message, recipient, true);
            
            addToPrivateMessagesList(currentUsername, message, recipient, true);
        }
        
        function addToPrivateMessagesList(from, message, to, isFromSelf = false, isAdminView = false) {
            const pmList = document.getElementById('privateMessagesList');
            if (!pmList) return;
            
            const msgDiv = document.createElement('div');
            msgDiv.style.padding = '10px';
            msgDiv.style.borderBottom = '1px solid #333';
            
            let bgColor = 'rgba(102,126,234,0.1)';
            if (isFromSelf) {
                bgColor = 'rgba(74, 222, 128, 0.1)';
            } else if (to === currentUsername) {
                bgColor = 'rgba(255, 153, 255, 0.1)';
            } else if (isAdminView) {
                bgColor = 'rgba(255, 215, 0, 0.1)';
            }
            
            msgDiv.style.background = bgColor;
            
            const fromRank = onlineUsers.find(u => u.username === from)?.rank || 'member';
            const toRank = onlineUsers.find(u => u.username === to)?.rank || 'member';
            
            msgDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="color: ${isFromSelf ? '#4ade80' : '#ff99ff'};">
                            ${isFromSelf ? 'You' : from} ‚Üí ${to === currentUsername ? 'You' : to}
                        </span>
                        ${getRankBadge(fromRank)}
                        ${isAdminView ? '<span style="color: gold; font-size: 10px; margin-left: 5px;">(admin)</span>' : ''}
                    </div>
                    <span style="color: #888; font-size: 11px;">${new Date().toLocaleTimeString()}</span>
                </div>
                <div style="margin-top: 5px; color: #fff;">${message}</div>
                <div style="font-size: 10px; color: #888; margin-top: 4px;">üîí Private message</div>
            `;
            
            pmList.insertBefore(msgDiv, pmList.firstChild);
        }
        
        socket.on('private_message', (data) => {
            const { from, fromRank, message, to, adminView } = data;
            
            let shouldShow = false;
            let isAdminView = false;
            
            if (from === currentUsername) {
                shouldShow = true;
            } else if (to === currentUsername) {
                shouldShow = true;
            } else {
                const viewerLevel = getRankLevel(currentRank);
                const senderLevel = getRankLevel(fromRank);
                
                if (viewerLevel < senderLevel) {
                    shouldShow = true;
                    isAdminView = true;
                }
            }
            
            if (!shouldShow) return;
            
            addPrivateMessage(from, message, to, from === currentUsername, isAdminView);
            
            addToPrivateMessagesList(from, message, to, from === currentUsername, isAdminView);
            
            // Send notification for private messages
            if (to === currentUsername) {
                sendNotification('üíå Private Message', `${from}: ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`);
                showToast(`üíå New message from ${from}`);
            } else if (isAdminView) {
                sendNotification('üëÄ Admin View', `${from} ‚Üí ${to}: ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`);
            }
        });
        
        socket.on('private_message_sent', (data) => {
            showToast(`üíå Message sent to ${data.to}`);
        });
        
        function loadPrivateMessageHistory() {
            const pmList = document.getElementById('privateMessagesList');
            if (pmList) {
                pmList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">Loading messages...</div>';
            }
            
            socket.emit('get_private_history');
        }
        
        socket.on('private_history', (data) => {
            const pmList = document.getElementById('privateMessagesList');
            if (!pmList) return;
            
            pmList.innerHTML = '';
            
            if (data.messages && data.messages.length > 0) {
                data.messages.reverse().forEach(msg => {
                    const isFromSelf = msg.from === currentUsername;
                    const isToSelf = msg.to === currentUsername;
                    const viewerLevel = getRankLevel(currentRank);
                    const senderLevel = getRankLevel(msg.fromRank);
                    const isAdminView = viewerLevel < senderLevel && !isFromSelf && !isToSelf;
                    
                    if (isFromSelf || isToSelf || isAdminView) {
                        addToPrivateMessagesList(msg.from, msg.message, msg.to, isFromSelf, isAdminView);
                    }
                });
            } else {
                pmList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No messages yet</div>';
            }
        });
        
        // ========== COMMANDS ==========
        
        function handleCommand(commandText) {
            const parts = commandText.split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);
            
            switch(command) {
                case '/help':
                    showHelp();
                    break;
                case '/users':
                    handleUsersCommand();
                    break;
                case '/msg':
                    handleMsgCommand(args);
                    break;
                case '/clear':
                    handleClearCommand(args);
                    break;
                case '/flip':
                    handleFlipCommand();
                    break;
                case '/roll':
                    handleRollCommand(args);
                    break;
                case '/ban':
                    handleBanCommand(args);
                    break;
                case '/unban':
                    handleUnbanCommand(args);
                    break;
                case '/delete':
                    handleDeleteCommand(args);
                    break;
                case '/effect':
                    handleEffectCommand(args);
                    break;
                case '/theme':
                    handleThemeCommand(args);
                    break;
                case '/grant':
                    handleGrantCommand(args);
                    break;
                case '/rank':
                    handleRankCommand(args);
                    break;
                case '/ping':
                    handlePingCommand();
                    break;
                default:
                    addSystemMessage(`‚ùå Unknown command: ${command}. Type /help for commands.`);
            }
        }
        
        function handleUsersCommand() {
            if (!currentRoom) {
                addSystemMessage('‚ùå Not in a room');
                return;
            }
            showUserList();
        }
        
        function handleMsgCommand(args) {
            if (args.length < 2) {
                addSystemMessage('Usage: /msg <username> <message>');
                return;
            }
            
            const recipient = args[0];
            const message = args.slice(1).join(' ');
            
            const recipientExists = onlineUsers.some(u => u.username === recipient);
            if (!recipientExists) {
                addSystemMessage(`‚ùå User '${recipient}' not found in room`);
                return;
            }
            
            socket.emit('private_message', {
                recipient,
                message,
                senderRank: currentRank,
                senderRankLevel: getRankLevel(currentRank)
            });
        }
        
        function handleClearCommand(args) {
            if (!currentRoom) {
                addSystemMessage('‚ùå Not in a room');
                return;
            }
            
            if (isModerator) {
                socket.emit('clear_messages', { 
                    roomName: currentRoom, 
                    password: '' 
                });
            } else {
                const password = args.join(' ');
                if (!password) {
                    addSystemMessage('Usage: /clear <password>');
                    return;
                }
                socket.emit('clear_messages', { 
                    roomName: currentRoom, 
                    password 
                });
            }
        }
        
        function handleFlipCommand() {
            const result = Math.random() < 0.5 ? 'HEADS' : 'TAILS';
            socket.emit('chat message', { 
                username: 'System', 
                message: `ü™ô ${currentUsername} flipped a coin... ${result}!` 
            });
        }
        
        function handleRollCommand(args) {
            if (args.length < 2) {
                addSystemMessage('Usage: /roll <min> <max>');
                return;
            }
            
            const min = parseInt(args[0]);
            const max = parseInt(args[1]);
            
            if (isNaN(min) || isNaN(max)) {
                addSystemMessage('‚ùå Invalid numbers');
                return;
            }
            
            if (min >= max) {
                addSystemMessage('‚ùå Min must be less than max');
                return;
            }
            
            const result = Math.floor(Math.random() * (max - min + 1)) + min;
            socket.emit('chat message', { 
                username: 'System', 
                message: `üé≤ ${currentUsername} rolled... ${result}!` 
            });
        }
        
        function handleBanCommand(args) {
            if (!currentRoom) {
                addSystemMessage('‚ùå Not in a room');
                return;
            }
            
            if (!isModerator && !isAdmin && !isOwner) {
                addSystemMessage('‚ùå You do not have permission');
                return;
            }
            
            if (args.length < 1) {
                addSystemMessage('Usage: /ban <username> [duration]');
                return;
            }
            
            const targetUser = args[0];
            
            const targetRank = onlineUsers.find(u => u.username === targetUser)?.rank || 'member';
            const targetLevel = getRankLevel(targetRank);
            const userLevel = getRankLevel(currentRank);
            
            if (targetLevel <= userLevel && currentRank !== 'owner') {
                addSystemMessage('‚ùå Cannot ban users of equal or higher rank');
                return;
            }
            
            let duration = '10m';
            if (args.length >= 2 && /^\d+[hmd]?$/.test(args[1])) {
                duration = args[1];
            }
            
            socket.emit('ban_user', {
                roomName: currentRoom,
                bannedUser: targetUser,
                duration,
                bannerName: currentUsername,
                password: ''
            });
        }
        
        function handleUnbanCommand(args) {
            if (!currentRoom) {
                addSystemMessage('‚ùå Not in a room');
                return;
            }
            
            if (!isAdmin && !isOwner) {
                addSystemMessage('‚ùå Only admins can unban');
                return;
            }
            
            if (args.length < 1) {
                addSystemMessage('Usage: /unban <username>');
                return;
            }
            
            socket.emit('unban_user', {
                roomName: currentRoom,
                unbannedUser: args[0],
                unbannerName: currentUsername,
                password: ''
            });
        }
        
        function handleDeleteCommand(args) {
            if (!isAdmin && !isOwner) {
                addSystemMessage('‚ùå Only admins can delete rooms');
                return;
            }
            
            if (args.length < 1) {
                addSystemMessage('Usage: /delete <roomname>');
                return;
            }
            
            const roomName = args[0];
            
            if (roomName === 'Main') {
                addSystemMessage('‚ùå Cannot delete Main room');
                return;
            }
            
            socket.emit('delete_room', {
                roomName,
                password: ''
            });
        }
        
        function handleEffectCommand(args) {
            if (!isAdmin && !isOwner) {
                addSystemMessage('‚ùå Only admins can use effects');
                return;
            }
            
            if (!currentRoom) {
                addSystemMessage('‚ùå Not in a room');
                return;
            }
            
            if (args.length < 1) {
                addSystemMessage('Usage: /effect <name>');
                return;
            }
            
            const effect = args[0].toLowerCase();
            socket.emit('effect_command', {
                effect,
                roomName: currentRoom
            });
        }
        
        function handleThemeCommand(args) {
            if (!isVip) {
                addSystemMessage('‚ùå VIP+ only can change themes');
                return;
            }
            
            if (args.length < 1) {
                addSystemMessage('Usage: /theme <name>');
                return;
            }
            
            const theme = args[0].toLowerCase();
            changeTheme(theme, 'personal');
        }
        
        function handleGrantCommand(args) {
            if (!isAdmin && !isOwner) {
                addSystemMessage('‚ùå Only admins can grant ranks');
                return;
            }
            
            if (args.length < 2) {
                addSystemMessage('Usage: /grant <username> <rank>');
                return;
            }
            
            const targetUser = args[0];
            const newRank = args[1].toLowerCase();
            
            const validRanks = isOwner ? ['admin', 'moderator', 'vip', 'member'] : ['moderator', 'vip', 'member'];
            
            if (!validRanks.includes(newRank)) {
                addSystemMessage(`‚ùå You can only grant: ${validRanks.join(', ')}`);
                return;
            }
            
            if (isOwner) {
                socket.emit('grant_rank', {
                    targetUser,
                    newRank,
                    password: ''
                });
            } else {
                const password = prompt('Enter admin password:');
                if (password) {
                    socket.emit('grant_rank', {
                        targetUser,
                        newRank,
                        password
                    });
                }
            }
        }
        
        function handleRankCommand() {
            addSystemMessage(`Your rank: ${currentRank.toUpperCase()} (Level ${getRankLevel(currentRank)}/5)`);
        }
        
        function handlePingCommand() {
            const start = Date.now();
            socket.emit('ping', () => {
                const latency = Date.now() - start;
                addSystemMessage(`üèì Pong! Latency: ${latency}ms`);
            });
        }
        
        // ========== EFFECTS ==========
        
        socket.on('room_effect', (data) => {
            addSystemMessage(`‚ú® ${data.triggeredBy} triggered: ${data.effect}`);
            
            document.body.classList.remove('glitch', 'flashbang', 'black', 'hack', 'matrix', 
                'rainbow', 'neon', 'firework', 'gameroom');
            
            switch(data.effect) {
                case 'glitch':
                    document.body.classList.add('glitch');
                    setTimeout(() => document.body.classList.remove('glitch'), 5000);
                    break;
                case 'flashbang':
                    document.body.classList.add('flashbang');
                    setTimeout(() => document.body.classList.remove('flashbang'), 1000);
                    break;
                case 'black':
                    document.body.classList.add('black');
                    setTimeout(() => document.body.classList.remove('black'), 5000);
                    break;
                case 'hack':
                    document.body.classList.add('hack');
                    setTimeout(() => document.body.classList.remove('hack'), 10000);
                    break;
                case 'matrix':
                    document.body.classList.add('matrix');
                    setTimeout(() => document.body.classList.remove('matrix'), 10000);
                    break;
                case 'rainbow':
                    document.body.classList.add('rainbow');
                    setTimeout(() => document.body.classList.remove('rainbow'), 5000);
                    break;
                case 'neon':
                    document.body.classList.add('neon');
                    setTimeout(() => document.body.classList.remove('neon'), 5000);
                    break;
                case 'firework':
                    document.body.classList.add('firework');
                    setTimeout(() => document.body.classList.remove('firework'), 2000);
                    break;
                case 'confetti':
                    for (let i = 0; i < 100; i++) {
                        setTimeout(() => createConfetti(), i * 10);
                    }
                    break;
                case 'gameroom':
                    document.body.classList.add('gameroom');
                    setTimeout(() => document.body.classList.remove('gameroom'), 10000);
                    break;
            }
        });
        
        function triggerEffect(effect) {
            socket.emit('effect_command', {
                effect,
                roomName: currentRoom
            });
            closeModal('effectsModal');
        }
        
        function createConfetti() {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
            confetti.style.animationDelay = Math.random() * 2 + 's';
            confetti.style.width = Math.random() * 10 + 5 + 'px';
            confetti.style.height = Math.random() * 10 + 5 + 'px';
            confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 3000);
        }
        
        // ========== THEMES ==========
        
        function showThemeSelector() {
            showModal('themeModal');
        }
        
        function changeTheme(theme, scope = 'personal') {
            document.body.setAttribute('data-theme', theme);
            currentTheme = theme;
            
            if (scope === 'room' && isVip && currentRoom) {
                socket.emit('change_theme', {
                    theme,
                    scope: 'room'
                });
                showToast(`üé® Room theme changed to: ${theme}`);
            } else {
                showToast(`üé® Personal theme changed to: ${theme}`);
            }
        }
        
        // ========== USER LIST ==========
        
        function showUserList() {
            showModal('userListModal');
            socket.emit('get_room_users', { roomName: currentRoom });
        }
        
        function quickBan(username) {
            if (username === currentUsername) {
                showToast('‚ùå Cannot ban yourself');
                return;
            }
            
            const targetRank = onlineUsers.find(u => u.username === username)?.rank || 'member';
            const targetLevel = getRankLevel(targetRank);
            const userLevel = getRankLevel(currentRank);
            
            if (targetLevel <= userLevel && currentRank !== 'owner') {
                showToast('‚ùå Cannot ban users of equal or higher rank');
                return;
            }
            
            const duration = prompt('Ban duration (e.g., 10m, 1h, 1d):', '10m');
            if (duration) {
                socket.emit('ban_user', {
                    roomName: currentRoom,
                    bannedUser: username,
                    duration,
                    bannerName: currentUsername,
                    password: ''
                });
                closeModal('userListModal');
            }
        }
        
        function quickMsg(username) {
            closeModal('userListModal');
            showModal('privateMessagesModal');
            document.getElementById('pmRecipient').value = username;
            document.getElementById('pmRecipientSelect').value = username;
            document.getElementById('pmMessage').focus();
        }
        
        function updateOnlineUsers() {
            if (currentRoom) {
                socket.emit('get_room_users', { roomName: currentRoom });
            }
        }
        
        // ========== MODALS ==========
        
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        };
        
        // ========== ROOM MANAGEMENT ==========
        
        function leaveRoom() {
            if (isVoiceActive && voiceChat) {
                voiceChat.stop();
                isVoiceActive = false;
            }
            socket.emit('leave_room');
            currentRoom = null;
            roomScreen.style.display = 'flex';
            chatScreen.style.display = 'none';
            loadRooms();
            showToast('üö™ Left room');
        }
        
        // ========== SOCKET EVENT HANDLERS ==========
        
        socket.on('error', (data) => {
            showToast('‚ùå ' + data.message);
        });
        
        socket.on('command_error', (data) => {
            addSystemMessage('‚ùå ' + data.message);
        });
        
        socket.on('command_success', (data) => {
            addSystemMessage('‚úÖ ' + data.message);
        });
        
        socket.on('messages_cleared', () => {
            msgContainer.innerHTML = '';
            addSystemMessage('üßπ All messages cleared');
        });
        
        socket.on('user_banned', (data) => {
            if (data.bannedUser === currentUsername) {
                showToast(`‚õî You have been banned for ${data.duration || '10m'}`);
                setTimeout(() => leaveRoom(), 2000);
            }
        });
        
        socket.on('user_unbanned', (data) => {
            addSystemMessage(`‚úÖ ${data.unbannedUser} unbanned by ${data.unbannerName}`);
        });
        
        socket.on('force_leave', (data) => {
            if (data.reason === 'banned') {
                showToast('‚õî You have been banned');
                setTimeout(() => leaveRoom(), 1000);
            }
        });
        
        socket.on('room_deleted_by_owner', (data) => {
            showToast(`üóëÔ∏è Room "${data.roomName}" deleted`);
            if (currentRoom === data.roomName) {
                setTimeout(() => leaveRoom(), 2000);
            }
        });
        
        socket.on('theme_applied', (data) => {
            if (data.scope === 'room') {
                addSystemMessage(`üé® Room theme changed to ${data.theme} by ${data.changedBy}`);
                document.body.setAttribute('data-theme', data.theme);
                document.getElementById('room-theme-indicator').innerHTML = `üé® ${data.theme}`;
            }
        });
        
        socket.on('system_notification', (data) => {
            addSystemMessage(data.message);
            showToast(data.message);
            sendNotification('System', data.message);
        });
        
        socket.on('ping', (cb) => {
            if (cb) cb();
        });
        
        // ========== UI EVENT LISTENERS ==========
        
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.emoji-btn') && !e.target.closest('.emoji-panel')) {
                emojiPanel.classList.remove('show');
            }
        });
        
        document.getElementById('loginUsername').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') handleLogin(); 
        });
        document.getElementById('loginPassword').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') handleLogin(); 
        });
        document.getElementById('regUsername').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') handleRegister(); 
        });
        document.getElementById('regPassword').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') handleRegister(); 
        });
        document.getElementById('regConfirmPassword').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') handleRegister(); 
        });
        
        document.getElementById('pmRecipientSelect')?.addEventListener('change', (e) => {
            document.getElementById('pmRecipient').value = e.target.value;
        });
        
        // ========== INITIAL CONNECTION ==========
        
        socket.on('connect', () => {
            console.log('‚úÖ Connected to Black Hole Chat V2');
            showToast('‚úÖ Connected to server');
            socket.emit('check_auth');
        });
        
        socket.on('auth_status', (data) => {
            if (data.authenticated) {
                currentUsername = data.username;
                updateRankUI(data.rank);
                loggedInUsernameDisplay.textContent = data.username;
                usernameDisplay.textContent = data.username;
                
                if (data.theme) {
                    changeTheme(data.theme, 'personal');
                }
                
                authScreen.style.display = 'none';
                roomScreen.style.display = 'flex';
                loadRooms();
                
                showToast(`üëã Welcome back, ${data.username}!`);
            } else {
                authScreen.style.display = 'flex';
                roomScreen.style.display = 'none';
                chatScreen.style.display = 'none';
            }
        });
        
        socket.on('disconnect', () => {
            addSystemMessage('‚ö†Ô∏è Disconnected from server. Reconnecting...');
            showToast('‚ö†Ô∏è Disconnected - reconnecting...');
        });
        
        socket.on('reconnect', () => {
            addSystemMessage('‚úÖ Reconnected to server');
            showToast('‚úÖ Reconnected');
            if (currentRoom) {
                socket.emit('join_room', { roomName: currentRoom, password: '' });
            }
        });
        
        // Check notification support on load
        if (checkNotificationSupport() && Notification.permission === 'granted') {
            notificationPermission = true;
            notificationsEnabled = true;
            const btn = document.getElementById('notificationPermissionBtn');
            if (btn) {
                btn.classList.add('enabled');
                btn.innerHTML = '<span>üîî</span> <span>Notifications Enabled</span>';
            }
        }
    </script>
</body>
</html>